---
title: 调优案例分析与实战（一）
date: 2019-07-16 21:35:40
tags:
	- Java
	- Java虚拟机
	- JVM调优实战
categories:
	- 深入理解Java虚拟机
---

### 高性能硬件上的程序部署策略

在高性能硬件上部署程序，目前主要有两种方式：

- 通过64位JDK来使用大内存。
- 使用若干个32位虚拟机建立逻辑集群来利用硬件资源。


如果考虑使用64位的JDK来管理大内存，还需要考虑下面可能面临的问题：

- 内存回收导致的长时间停顿。
- 现阶段，64位JDK的性能测试结果普遍低于32位JDK。
- 需要保证程序足够稳定，因为这种应用要是产生堆溢出几乎就无法产生堆转储快照（因为要产生十几GB乃至更大的Dump文件），哪怕产生了快照也无法进行分析。
- 相同程序在64位JDK消耗的内存一般比32位的大，这是由于指针膨胀，以及数据类型对齐补白等因素导致的。

如果计划使用逻辑集群的方式来部署程序，可能会遇到下面一些问题：

- 尽量避免节点竞争全局的资源，最典型的就是磁盘竞争，各个节点如果同时访问某个磁盘文件的话（尤其是并发写操作容易出现问题），很容易导致IO异常。
- 很难高效率地利用某些资源池，譬如连接池，一般都是在各个节点建立自己独立的连接池，这样有可能导致一些节点池满了而另一些节点仍有较多空余。尽管可以使用集中式的JNDI，但这个有一定的复杂性并且可能带来额外的性能开销。
- 各个节点仍然不可避免地受到32位的内存限制，在32位Windows平台中每个进程只能使用2GB的内存，考虑到堆以外的内存开销，堆一般最多只能开到1.5GB。在某些Linux或UNIX系统（如Solaris中），可以提升到3GB乃至接近4GB的内存，但32位中仍然受到最高4GB（2^32）内存的限制。
- 大量使用本地缓存（如大量使用HashMap作为K/V缓存）的应用，在逻辑集群中会造成较大的内存浪费，因为每个逻辑节点上都有一份缓存，这时候可以考虑把本地缓存改为集中式缓存。

<!-- more-->

### 集群同步导致的内存溢出

### 堆外内存导致的溢出错误

垃圾收集进行时，虚拟机虽会对Direct Memory进程回收，但是Direct Memory却不像新生代、老年代那样，发现空间不足了就通知收集器进行回收，它只能等老年代满了之后Full GC，然后“顺便地”帮它清理掉内存的废弃对象。否则它只能一直等到抛出异常时，先catch块里“大喊”一声：“System.gc()！”。要是虚拟机还是不听（譬如打开了`-XX:-DisableExplicitGC`开关），那就只能眼睁睁地看着堆中还有许多空闲内存，自己却不得不抛出异常了。

- Direct Memory：可通过`-XX:MaxDirectMemorySize`调整大小，内存不足时抛出OutOfMemoryError或OutOfMemoryError：Direct buffer memory。
- 线程堆栈：可通过`-Xss`调整大小，内存不足时抛出StackOverflowError（纵向无法分配，即无法分配新的栈帧）或者OutOfMemoryError：unable to create new native thread（横向无法分配，即无法创建新的线程）。
- Socket缓存区：每个Socket连接都Receive和Send两个缓存区，分别占37KB和25KB内存，连接多的话这块内存占用比较客观。如果无法分配，则可能会抛出IOException：Too many open files异常。
- JNI代码：如果代码中使用JNI调用本地库，那本地库使用的内存也不在堆中。
- 虚拟机和GC：虚拟机、GC的代码执行也要消耗一定的内存。

### 外部命令导致系统变慢

### 服务器JVM进程崩溃

### 不恰当数据结构导致内存占用过大

回顾：

- `-XX:SurvivorRatio=65536`
- `-XX:MaxTenuringThreshold=0`
- `-XX:+AlwaysTenure`

### 由Windows虚拟内存导致长时间停顿

- `-XX:PrintGCApplicationStoppedTime`:打印垃圾回收期间程序暂停的时间
- `-XX:+PrintGCDateStamps`:显示执行GC时的本地时间（Java 6 update 4才开始支持）
- `-Xloggc:gclog.log`:打开或关闭GC日志滚动记录功能
- `-XX:+PrintReferenceGC`:打印各种引用的处理时间

GUI程序内存变化的一个特点，当它最小化时，资源管理中显示的占用内存大幅度减小，但是虚拟机内存则没有变化，因此怀疑程序在最小化时它的工作内存被自动交换到磁盘的页面文件中了，这样发生GC时就有可能因为恢复页面文件操作而导致不正常的GC停顿。

为避免这种现象，可加入参数`-Dsun.awt.keepWorkingSetOnMinimize=true`来解决。